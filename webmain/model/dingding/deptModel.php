<?php
/**
*	来自：信呼开发团队
*	作者：磐石(rainrock)
*	网址：http://www.rockoa.com/
*	系统文件
*/
class dingding_deptClassModel extends dingdingModel { public function initWeixin() { $this->settable('zding_dept'); } public function getdeptlist() { $token = $this->gettoken(); $url = ''.$this->gettourl('URL_deptlist').'?access_token='.$token.'&id=1'; $barr = $this->backarr; $result = c('curl')->getcurl($url); if(!$this->isempt($result)){ $arr = json_decode($result); $barr['errcode'] = $arr->errcode; $barr['msg'] = $arr->errmsg; if($arr->errmsg=='ok'){ $list = $arr->department; $idss = '0'; $vardj = new StdClass(); $vardj->id = 1; $vardj->parentid= 0; $vardj->bmid = 1; $ddb = m('dept'); $vardj->name = $ddb->getmou('name', 1); $list[] = $vardj; foreach($list as $k=>$rs){ $name = $rs->name; $id = $rs->id; $parentid = $rs->parentid; $idss .= ','.$id.''; $ids = 0; $ors = $this->getone("`id`='$id'"); $where = ''; $bmid = isset($rs->bmid) ? $rs->bmid : 0; if($ors){ $ids = $ors['id']; $where= "`id`=$ids"; $bmid = $ors['bmid']; } if($bmid==0)$bmid = (int)$ddb->getmou('id', "`name`='$name' and `pid`='$parentid'"); $this->record(array( 'id' => $id, 'name' => $name, 'bmid' => $bmid, 'parentid' => $parentid ), $where); } $this->delete("id not in($idss)"); } } return $barr; } private $getddepta = array(); private $getddeptac = 1; private function getddept($pid=0, $bmid=0) { $rows = $this->getall('parentid='.$pid.'','*','`order`,`id`'); foreach($rows as $k=>$rs){ $rs['pid'] = $bmid; $rs['bmid'] = $this->getddeptac; $this->getddepta[] = $rs; $this->getddeptac++; $this->getddept($rs['id'], $rs['bmid']); } return $this->getddepta; } public function anaytosys() { $barr = $this->backarr; $rows = $this->getall('id>0'); if(!$rows){ $barr['msg']='请先获取列表在同步'; return $barr; } $idss = '0'; $db = m('dept'); $rows = $this->getddept(); $xus = 0; foreach($rows as $k=>$rs){ $name = $rs['name']; $id = $rs['bmid']; $pid = $rs['pid']; $sort = $rs['order']; $idss .= ','.$id.''; $ids = (int)$db->getmou('id', "`id`='$id'"); $where = ''; if($ids>0)$where="`id`=$ids"; $db->record(array( 'id' => $id, 'name' => $name, 'sort' => $sort, 'pid' => $pid ), $where); $this->update('bmid='.$id.'', $rs['id']); $xus++; } $db->delete("id not in($idss)"); $this->db->query('alter table `[Q]dept` AUTO_INCREMENT='.$xus.''); $barr['errcode'] = 0; $barr['msg'] = '同步成功'; return $barr; } public function createdept($id, $name, $parentid, $order) { $bmrs = $this->getone("`bmid`='$parentid'"); if(!$bmrs)return $this->setbackarr(-1,'钉钉的上级部门不存在'); $parentid = $bmrs['id']; $body = '{"name": "'.$name.'","parentid": '.$parentid.',"order": '.$order.'}'; $bmid = $id; $token = $this->gettoken(); $url = ''.$this->gettourl('URL_deptcreate').'?access_token='.$token.''; $barr = $this->backarr; $result = c('curl')->postjson($url, $body); if($result!=''){ $arr = json_decode($result); $barr['errcode'] = $arr->errcode; $barr['msg'] = $arr->errmsg; if($arr->errcode==0){ $this->record(array( 'id' => $arr->id, 'name' => $name, 'parentid' => $parentid, 'order' => $order, 'bmid' => $bmid, )); } } return $barr; } public function updatedept($id, $name, $parentid, $order) { $ors = $this->getone("`bmid`='$id'"); if(!$ors)return $this->setbackarr(-1,'钉钉上部门不存在，请先获取'); $parentid = $ors['parentid']; $id = $ors['id']; $bmid = $ors['bmid']; $body = '{"name": "'.$name.'","order": "'.$order.'"'; if($parentid>0)$body.= ',"parentid": "'.$parentid.'"'; $body .= ',"id": "'.$id.'"}'; $token = $this->gettoken(); $url = ''.$this->gettourl('URL_deptupdate').'?access_token='.$token.''; $barr = $this->backarr; $result = c('curl')->postjson($url, $body); if($result!=''){ $arr = json_decode($result); $barr['errcode'] = $arr->errcode; $barr['msg'] = $arr->errmsg; if($arr->errcode==0){ $this->record(array( 'id' => $id, 'name' => $name, 'parentid' => $parentid, 'bmid' => $bmid, 'order' => $order ),"`id`='$id'"); } } return $barr; } public function deletedept($id) { $token = $this->gettoken(); $url = ''.$this->gettourl('URL_deptdelete').'?access_token='.$token.'&id='.$id.''; $barr = $this->backarr; $result = c('curl')->getcurl($url); if(!$this->isempt($result)){ $arr = json_decode($result); $barr['errcode'] = $arr->errcode; $barr['msg'] = $arr->errmsg; if($arr->errcode==0){ $this->delete($id); } } return $barr; } }