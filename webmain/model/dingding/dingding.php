<?php
/**
*	来自：信呼开发团队
*	作者：磐石(rainrock)
*	网址：http://www.rockoa.com/
*	系统文件
*/
class dingdingModel extends Model { protected $URL_public = 'yt0te0ie0di0yy0te0tt0qd0td0abq0tt0di0ti0aee0aaq0aby0tm0aee0ia0qa0ty0qb0qt0abd0yy0ta0abt0aat0yb0ta0abi0aat0yb0qa0ie0abd0yi0ta0aaq0aat0iy0qb0qt0aaf0tf0aay0qi0qi011'; protected $URL_gettoken = 'tz0mz0fd0ef0rzz0qr0mq0rre0tz0fq0mb0mf09'; protected $URL_jsapiticket = 'al0ol0bz0pb0bb0ol0ggx0gxx0ba0bb0zz0ggx0bb0og0bx0ggx0ba0ol0ggz0glb0gll0zo0ob0ob03'; protected $URL_deptlist = 'fo0dz0qm0zzf0qf0qq0da0aq0fq0qd0qm0zzd0zoo0md0ed0zze0fd0qq0dq0aq08'; protected $URL_deptcreate = 'eg0bx0ar0xxe0ae0aa0bo0oa0ea0ab0ar0xxb0xgg0rb0zb0xgr0ee0xge0ar0xgo0xgg0bx0az0za04'; protected $URL_deptupdate = 'tz0qr0fd0rrt0ft0ff0qe0ef0tf0fq0fd0rrq0rzz0dq0mq0et0tt0qr0fb0rze0rzz0qr0fm0mf09'; protected $URL_deptdelete = 'yb0ta0if0aay0iy0ii0td0di0yi0it0if0aat0abb0ft0qt0abt0yb0it0aeb0abi0abb0ta0iq0qi011'; protected $URL_userlist = 'kss0zz0oz0ksz0rr0ksc0co0kkc0ro0zz0oz0xz01'; protected $URL_userget = 'pcc0mm0em0pcm0dd0pcb0be0ppc0dc0mm0mp0bm06'; protected $URL_usercreate = 'kss0zz0oz0ksz0rr0ksc0co0ksp0rr0ksr0zp0ksx0kss0ok0zc0cz01'; protected $URL_userupdate = 'abb0ii0ti0abi0yy0abq0qt0dy0yy0ta0ie0abd0abb0ta0iq0qi011'; protected $URL_userdelete = 'pcc0mm0em0pcm0dd0pcb0be0pce0dc0me0poc0pcm0pcc0ep0mb0bm06'; protected $URL_batchdelete = 'rzz0ff0qf0rzf0tt0rzm0mq0rzm0ft0ff0fb0rzd0tq0qr0fb0rzf0tf0qr0fd0ef0tz0fr0mf0mf09'; protected $URL_getuserinfo = 'mee0vv0yv0mev0hh0met0ty0mme0he0vv0vd0fh0hh0te0vi0mdm0hy0vy0tq0meh0hv0mmh0tv0tv013'; protected $URL_chatsend = 'message/send_to_conversation'; protected $URL_agentsend = 'eb0bc0ac0oa0ee0bc0bb0zo0bo0xgz0bb0oa0ba0xcc0xxz0xge0bp0xcc0ax0zx0be0zg0ar0xgr0ea0xcx0zp0oa0ae0ab0zb0xgz0ae0ab0zr0xxb0ae0zg0zb0xxr0br0zx0bo0xxa0xgg0aa0ac0xga0ee0xgz0zb0xcx0eg0aa0ba0oa04'; protected $URL_attendance = 'yv0yy0ym0qy0va0yi0fd0eai0yv0yi0fd0eat0va0yd0fi0eef0vi0yy0iy0qy0yf0eav0yt0eat0vy0fe0iq0eai012'; protected $URL_mediaupload = 'br0rz0ro0lkz0bz0rz0ob0llr0lkk0rr0oo0llp0br0pk0zk0lkz02'; protected $URL_mediaget = 'br0rz0ro0lkz0bz0rz0ob0llr0bk0pk0ro0cr02'; public $corpid = ''; public $optionpid = '-5'; public $backarr = array(); private $secret = ''; public function initWeixin(){} public function initModel() { $this->backarr = array('errcode'=>-1, 'msg'=>'sorry,error'); $this->option = m('option'); $this->initWeixin(); } public function gettourl($can, $nfa=false) { $url = $this->URL_public; if(substr($url,0,4)!='http'){ $url=$this->rock->jm->uncrypt($url); if($nfa)$url=''; $url.=$this->rock->jm->uncrypt($this->$can); }else{ if($nfa)$url=''; $url.=$this->$can; } return $url; } public function readwxset() { if($this->corpid!='')return $this->corpid; $this->qiyeid = $this->option->getval('dingding_qiyeid'); $this->corpid = $this->option->getval('dingding_corpid'); $this->secret = $this->option->getval('dingding_secret'); if($this->corpid=='' || $this->secret=='')showreturn('','没有设置钉钉',201); return $this->corpid; } public function gettoken($lx=0) { $time = date('Y-m-d H:i:s', time()-2*3600); $rs = $this->option->getone("`num`='dingding_token".$lx."' and `optdt`>'$time'"); $val = ''; if($rs)$val = $rs['value']; if(isempt($val)){ $this->readwxset(); $secret = $this->secret; if(isempt($secret))return ''; $url = ''.$this->gettourl('URL_gettoken').'?corpid='.$this->corpid.'&corpsecret='.$secret.''; $result = c('curl')->getcurl($url); if($result != ''){ $arr = json_decode($result); if(!isset($arr->access_token)){ showreturn('',$result,201); }else{ $val = $arr->access_token; $this->option->setval('dingding_token'.$lx.'@'.$this->optionpid.'', $val); } } } if(isempt($val))showreturn('','无法获取token',201); return $val; } public function getticket() { $time = date('Y-m-d H:i:s', time()-2*3600); $rs = $this->option->getone("`num`='dingding_token1' and `optdt`>'$time'"); $val = ''; if($rs)$val = $rs['value']; if(isempt($val)){ $token = $this->gettoken(); $url = ''.$this->gettourl('URL_jsapiticket').'?access_token='.$token.''; $result = c('curl')->getcurl($url); if($result != ''){ $arr = json_decode($result); if(!isset($arr->ticket)){ showreturn('', $result, 201); }else{ $val = $arr->ticket; $this->option->setval('dingding_token1@'.$this->optionpid.'', $val); } } } if(isempt($val))showreturn('','无法获取token_ticket',201); return $val; } public function setbackarr($code, $msg) { $this->backarr = array('errcode'=>$code, 'msg'=>$msg); return $this->backarr; } public function backerror($msg, $code=-1) { return $this->setbackarr($code, $msg); } public function clearalltoken() { $this->option->update("value=null", "`num` like 'dingding\_%'"); } }