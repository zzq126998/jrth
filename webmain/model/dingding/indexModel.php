<?php
/**
*	来自：信呼开发团队
*	作者：磐石(rainrock)
*	网址：http://www.rockoa.com/
*	系统文件
*/
class dingding_indexClassModel extends dingdingModel { private $agentcolor = ''; public function getagentid($names) { $agesta = explode(',', $names); $name = $agesta[0]; $sid = -1; $where = "`name`='$name'"; if(is_numeric($name))$where='`agentid`='.$name.''; $nsrs = $this->db->getone('[Q]zding_agent', $where, '`agentid`,`color`'); if($nsrs){ $sid = (int)$nsrs['agentid']; $this->agentcolor = $nsrs['color']; } if($sid==-1 && count($agesta)>1){ $sid = $this->getagentid(substr($names, strpos($names, ',')+1)); } if($sid==-1){ $nsrs = $this->db->getone('[Q]zding_agent', "`ismr`=1", '`agentid`,`color`','`sort`,`id`'); if($nsrs){ $sid = (int)$nsrs['agentid']; $this->agentcolor = $nsrs['color']; } } return $sid; } private function sendmsg($touid, $agentname, $body, $msgtype='text', $url='') { $agentid= $this->getagentid($agentname); $msg = ''; $barr = array('errcode' => -1,'msg' => 'sorry!error'); if($agentid==-1){ $msg= 'not found agent['.$agentname.']'; $barr['msg'] = $msg; return $barr; } $touser = ''; $names = ''; if($touid=='all'){ $touser = 'all'; }else{ $uarrs= $this->db->getall("select a.`userid` from `[Q]zding_user` a left join `[Q]admin` b on (a.`userid`=b.`user`) or (a.`mobile`=b.`mobile` and b.`mobile` is not null) or (a.`email`=b.`email` and b.`email` is not null) where b.`id` in($touid) and a.`status`=1"); foreach($uarrs as $k=>$rs){ $touser.=','.$rs['userid'].''; } if($touser!='')$touser = substr($touser, 1); } if($touser==''){ $uarrs = $this->db->getall("select `user`,`name` from `[Q]admin` where `id` in($touid)"); foreach($uarrs as $k=>$rs)$names.=','.$rs['name'].''; $msg= '用户['.$touid.''.$names.']未关注，请到[系统→钉钉管理→钉钉用户]下查看关注状态，应用['.$agentname.']'; $barr['msg'] = $msg; return $barr; } $arr['msgtype'] = $msgtype; $arr['agent_id'] = $agentid; if($touser=='all'){ $arr['to_all_user'] = 'true'; }else{ $arr['userid_list'] = $touser; } if(!isempt($this->agentcolor))$body = str_replace('"FF1389D3"','"FF'.$this->agentcolor.'"', $body); if(!isempt($url)){ $jgs = contain($url,'?') ? '&' : '?'; $url.=''.$jgs.'agentid='.$agentid.''; } $url = str_replace(URL, $this->rock->getouturl(), $url); $body = str_replace('[URLURL]', urlencode($url), $body); $arr['msgcontent'] = $body; if(getconfig('asynsend')){ $ybbo = m('reim')->asynurl('asynrun','ddsendmsg', array( 'body' => $this->rock->jm->base64encode(json_encode($arr)) )); $barr['errcode'] = 0; $barr['msg'] = '异步发送'; if($ybbo)return $barr; } $barr = $this->sendbody($arr); return $barr; } public function sendbody($arr) { $barr = $this->backarr; if(!is_array($arr))$arr = json_decode($arr, true); $token = $this->gettoken(); $arr['session'] = $token; $arr['timestamp'] = $this->rock->now; $arr['method'] = 'dingtalk.corp.message.corpconversation.asyncsend'; $arr['format'] = 'json'; $arr['v'] = '2.0'; $url = $this->gettourl('URL_agentsend', true); $result = c('curl')->postcurl($url, $arr); if(!isempt($result)){ $arr = json_decode($result, true); if(isset($arr['error_response'])){ $barr['msg'] = $this->getmsg($arr['error_response']); $barr['errcode'] = arrvalue($arr['error_response'],'code'); }else{ $barr['errcode'] = 0; $barr['msg'] = 'ok'; } } return $barr; } private function getmsg($arr) { $s = ''; foreach($arr as $k=>$v)$s.=','.$k.':'.$v.''; if($s!='')$s= '{'.substr($s, 1).'}'; return $s; } public function sendtext($touid, $agentname, $cont) { $body = '{"content": "'.$cont.'"}'; return $this->sendmsg($touid, $agentname, $body,'text'); } public function sendoa($touid, $agentname, $sarr=array()) { $author = $this->rock->repempt($this->adminname, '系统'); $body = '{"message_url": "[URLURL]","pc_message_url":"[URLURL]","head":{"bgcolor":"FF1389D3","text":"'.$sarr['modename'].'"},"body":{"title":"'.$sarr['title'].'","content":"'.$sarr['content'].'","author":"'.$author.'"}}'; return $this->sendmsg($touid, $agentname, $body, 'oa', $sarr['wxurl']); } }