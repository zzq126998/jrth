<?php
/**
*	来自：信呼开发团队
*	作者：磐石(rainrock)
*	网址：http://www.rockoa.com/
*	系统文件
*/
class dingding_mediaClassModel extends dingdingModel { public function upload($file, $type='') { $token = $this->gettoken(); if($type=='')$type = 'image'; $url = ''.$this->gettourl('URL_mediaupload').'?access_token='.$token.'&type='.$type.''; $data = array('media'=>'@'.ROOT_PATH.'/'.$file); $result = c('curl')->postcurl($url, $data, 1); $barr = $this->backarr; $barr['msg']= '上传出错'; if($result != ''){ $arr = json_decode($result, true); if($arr['errcode']!=0){ $barr['errcode'] = $arr['errcode']; $barr['msg'] = $arr['errmsg']; }else{ $barr = $arr; $barr['errcode'] = 0; $barr['msg'] = 'ok'; } } return $barr; } public function downmedia($mediaid, $type='amr', $msgid='') { $token = $this->gettoken(); $url = ''.$this->gettourl('URL_mediaget').'?access_token='.$token.'&media_id='.$mediaid.''; $result = c('curl')->getcurl($url); $barr = $this->backarr; $bo = false; if(!isempt($result) && !contain($result, 'errcode')){ $sfile = ''.UPDIR.'/'.date('Y-m').'/'.substr(md5($mediaid),0,15).'.'.$type.''; $bo = $this->rock->createtxt($sfile , $result); } if(!$bo){ $barr['msg']= '下载出错'; }else{ $barr['errcode'] = 0; $barr['msg'] = 'ok'; $uarr['filepath'] = $sfile; $uarr['filename'] = '微信语音.'.$type.''; $uarr['fileext'] = $type; $uarr['filesize'] = filesize($sfile); $uarr['filesizecn'] = c('upfile')->formatsize($uarr['filesize']); $uarr['optid'] = $this->adminid; $uarr['optname'] = $this->adminname; $uarr['adddt'] = $this->rock->now; $fileid = m('file')->insert($uarr); if(!isempt($msgid)){ $dbss = m('im_mess'); $mors = $dbss->getone("`msgid`='$msgid'",'id'); if($mors){ $id = $mors['id']; $dbss->update(array('fileid' => $fileid), $id); m('file')->addfile($fileid, 'im_mess', $id); } } } return $barr; } }