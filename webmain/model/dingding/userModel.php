<?php
/**
*	来自：信呼开发团队
*	作者：磐石(rainrock)
*	网址：http://www.rockoa.com/
*	系统文件
*/
class dingding_userClassModel extends dingdingModel { public function initWeixin() { $this->settable('zding_user'); } public function getuserlist($detpid=1,$page=1) { $token = $this->gettoken(); $size = 100; $offset = ($page-1)*$size; $url = ''.$this->gettourl('URL_userlist').'?access_token='.$token.'&department_id='.$detpid.'&offset='.$offset.'&size='.$size.''; $barr = $this->backarr; $result = c('curl')->getcurl($url); if(!$this->isempt($result)){ $arr = json_decode($result); $barr['errcode'] = $arr->errcode; $barr['msg'] = $arr->errmsg; if($arr->errcode==0){ $list = $arr->userlist; $idss = "'0'"; $count = 0; foreach($list as $k=>$rs){ $idss .= ",'".$rs->userid."'"; $this->saveuserinfo($rs); $count++; } $barr['count'] = $count; $this->delete("`userid` not in($idss) and `department` like '%[".$detpid."]%'"); } } return $barr; } private function saveuserinfo($rs) { $userid = $rs->userid; $where = "`userid`='$userid'"; $reos = $this->getone($where,'userid'); if(!$reos)$where=''; $sarr = array( 'userid' => $userid, 'name' => $rs->name, 'department'=> json_encode($rs->department), 'position' => isset($rs->position) ? $rs->position : '', 'mobile' => isset($rs->mobile) ? $rs->mobile : '', 'tel' => isset($rs->tel) ? $rs->tel : '', 'email' => isset($rs->email) ? $rs->email : '', 'orgemail' => isset($rs->orgEmail) ? $rs->orgEmail : '', 'avatar' => isset($rs->avatar) ? $rs->avatar : '', 'jobnumber' => isset($rs->jobnumber) ? $rs->jobnumber : '', 'status' => $rs->active ? 1 : 0, ); $this->record($sarr, $where); } public function anaytosys() { $barr = $this->backarr; $rows = $this->getall('id>0'); if(!$rows){ $barr['msg']='请先获取钉钉上用户在同步'; return $barr; } $drows = m('zding_dept')->getall('1=1'); if(count($drows)==0){ $barr['msg']='请先同步钉钉部门'; return $barr; } $darrs = array(); foreach($drows as $k1=>$rs1){ $bmid = (int)$rs1['bmid']; if($bmid==0)$bmid=1; $darrs[$rs1['id']]=$bmid; } $idss = '0'; $db = m('admin'); $pyobj = c('pingyin'); $pass = md5('123456'); foreach($rows as $k=>$rs){ $name = $rs['name']; $user = $rs['userid']; $mobile = $rs['mobile']; $email = $rs['email']; $num = $rs['jobnumber']; $where = "`id`>0 and (`user`='$user' or `mobile`='$mobile' or `email`='$email')"; $ids = 0; $rso = $db->getone($where); if($rso)$ids= (int)$rso['id']; $uarr = array( 'name' => $name, 'ranking' => $rs['position'], 'mobile' => $rs['mobile'], 'email' => $rs['email'], ); $avatar = $rs['avatar']; if($ids==0){ $pingyin = $pyobj->get($name,1); if(is_numeric($user)){ $user=$pingyin; if($db->rows("`user`='$user'")>0)$user=''.$user.'1'; } $where = ''; $uarr['adddt'] = $this->rock->now; $uarr['workdate'] = arrvalue($rs,'hireddate',$this->rock->date); $uarr['pass'] = $pass; $uarr['sex'] = '男'; $uarr['user'] = $user; $uarr['companyid'] = 1; $uarr['deptid'] = 1; $uarr['sort'] = 1; if(!isempt($avatar))$uarr['face'] = $avatar; $uarr['pingyin'] = $pingyin; }else{ if(!isempt($avatar) && isempt($rso['face'])) $uarr['face'] = $avatar; } if(!isempt($rs['tel']))$uarr['tel'] = $rs['tel']; if(!isempt($num) && $num!=$user)$uarr['num'] = $num; $deptids = ''; if(!isempt($rs['department'])){ $depta = explode(',', str_replace(array('[',']'), array('',''), $rs['department'])); $uarr['deptid'] = arrvalue($darrs, $depta[0], 1); for($i=1;$i<count($depta);$i++){ $_tids = arrvalue($darrs, $depta[$i]); if(!isempt($_tids))$deptids.=','.$_tids.''; } if($deptids!='')$deptids=substr($deptids, 1); $uarr['deptids'] = $deptids; } $db->record($uarr, $where); } m('admin')->updateinfo(); $barr['errcode'] = 0; $barr['msg'] = '同步成功'; return $barr; } public function getuserinfo($userid) { $token = $this->gettoken(); $url = ''.$this->gettourl('URL_userget').'?access_token='.$token.'&userid='.$userid.''; $barr = $this->backarr; $result = c('curl')->getcurl($url); if(!$this->isempt($result)){ $arr = json_decode($result); $barr['errcode'] = $arr->errcode; $barr['msg'] = $arr->errmsg; if($arr->errcode==0){ $this->saveuserinfo($arr); } } return $barr; } public function anayface($userid, $hubo=false) { if($hubo){ $barr = $this->getuserinfo($userid); if($barr['errcode'] != 0)return $barr; } $avatar = $this->getmou('avatar', "`userid`='$userid'"); $barr = $this->backarr; if(isempt($avatar)){ $barr['msg'] = '获取失败或可能未关注企业号'; return $barr; } $cont = c('curl')->getcurl($avatar); $aaa = c('down')->createimage($cont,'jpg','微信头像'); $barr['face'] = ''; $barr['msg'] = '无法获取'; if($aaa){ $urs = m('admin')->getone("`user`='$userid'",'`id`'); if(!$urs){$barr['msg'] =''.$userid.'不存在';return $barr;} $uid = $urs['id']; $face = ''.UPDIR.'/face/'.$uid.'.jpg'; @copy($aaa['thumbpath'], $face); m('file')->delfile($aaa['id']); if(file_exists($face)){ m('admin')->update("`face`='$face'", $uid); $barr['errcode'] = 0; $barr['face'] = $face; $barr['msg'] = 'ok'; } } return $barr; } public function createuser($userid,$arr=array()) { $str = ''; foreach($arr as $k=>$v){ if($k!='department'){ $str.=',"'.$k.'":"'.$v.'"'; }else{ $str.=',"'.$k.'":'.$v.''; } } $body = '{"userid": "'.$userid.'"'.$str.'}'; $token = $this->gettoken(); $url = ''.$this->gettourl('URL_usercreate').'?access_token='.$token.''; $barr = $this->backarr; $result = c('curl')->postjson($url, $body); if($result!=''){ $arra = json_decode($result); $barr['errcode'] = $arra->errcode; $barr['msg'] = $arra->errmsg; if($arra->errcode==0){ $arr['userid'] = $userid; $this->record($arr); } } return $barr; } public function updateuser($userid,$arr=array(),$ostr='') { $str = ''; foreach($arr as $k=>$v){ if($k!='department'){ $str.=',"'.$k.'":"'.$v.'"'; }else{ $str.=',"'.$k.'":'.$v.''; } } $body = '{"userid": "'.$userid.'"'.$str.''.$ostr.'}'; $token = $this->gettoken(); $url = ''.$this->gettourl('URL_userupdate').'?access_token='.$token.''; $barr = $this->backarr; $result = c('curl')->postjson($url, $body); if($result!=''){ $arra = json_decode($result); $barr['errcode'] = $arra->errcode; $barr['msg'] = $arra->errmsg; if($arra->errcode==0){ $arr['userid'] = $userid; $this->record($arr, "`userid`='$userid'"); } if($arra->errcode==60121){ $this->delete("`userid`='$userid'"); } } return $barr; } public function deleteuser($userid) { if(isempt($userid))return $this->backerror('userid不能为空'); $token = $this->gettoken(); $url = ''.$this->gettourl('URL_userdelete').'?access_token='.$token.'&userid='.$userid.''; $barr = $this->backarr; $result = c('curl')->getcurl($url); if(!$this->isempt($result)){ $arr = json_decode($result); $barr['errcode'] = $arr->errcode; $barr['msg'] = $arr->errmsg; if($arr->errcode==0){ $this->delete("`userid`='$userid'"); } } return $barr; } public function deletepluser($arr=array()) { $token = $this->gettoken(); $url = ''.$this->gettourl('URL_batchdelete').'?access_token='.$token.''; $barr = $this->backarr; $s1 = ''; foreach($arr as $ss)$s1 .= ',"'.$ss.'"'; if($s1=='')return $barr; $s1 = substr($s1, 1); $body = '{"useridlist":['.$s1.']}'; $result = c('curl')->postjson($url, $body); if(!$this->isempt($result)){ $arr = json_decode($result); $barr['errcode'] = $arr->errcode; $barr['msg'] = $arr->errmsg; if($arr->errcode==0){ $barr['msg'] = 0; $this->delete('`userid` in('.$s1.')'); } } return $barr; } public function notinadmin($glx=0) { $sql = "select a.`userid` from `[Q]zding_user` a left join `[Q]admin` b on (a.`userid`=b.`user`) or (a.`mobile`=b.`mobile` and b.`mobile` is not null) or (a.`email`=b.`email` and b.`email` is not null) where b.id is null"; $rows= $this->db->getall($sql); $arr = array(); foreach($rows as $k=>$rs){ $arr[] = $rs['userid']; } return $arr; } public function delusernoinstr() { $arr = $this->notinadmin(); if(!$arr){ $barr = $this->backarr; $barr['msg'] = '没可删除的用户'; return $barr; } return $this->deletepluser($arr); } public function subscribe($user, $zt) { if(isempt($user))return; $where = "`userid`='$user'"; if($this->rows($where)==0)$where=''; $this->record(array( 'userid' => $user, 'status' => $zt, 'optdt' => $this->rock->now ), $where); if($zt == 1){ $urs = m('admin')->getone("`user`='$user'",'`face`,`id`'); if($urs)if(isempt($urs['face']))$this->anayface($user, true); } } private function checkEmail($inAddress) { return filter_var($inAddress, FILTER_VALIDATE_EMAIL); } public function optuserwx($id, $cjid=0) { $rs = m('admin')->getone("`id`='$id'",'`name`,`status`,`user`,mobile,email,ranking,tel,deptid,sex,`num`'); $userid = $rs['user']; $rs1 = $this->getone("`userid`='$userid' or id='$cjid'"); $arr = array( 'name' => $rs['name'], 'email' => $rs['email'], 'position' => $rs['ranking'], 'tel' => $rs['tel'] ); if(!isempt($rs['num']))$arr['jobnumber'] = $rs['num']; $deptid = $rs['deptid']; $isjh = 0; if($rs1 && $rs1['status']=='1')$isjh = 1; if(!isempt($deptid)){ $ode = $this->db->getone('[Q]zding_dept','bmid='.$deptid.''); if(!$ode)return $this->setbackarr(-1,'请先同步钉钉部门在创建用户'); $deptid = $ode['id']; $arr['department'] = '['.$deptid.']'; } if($isjh==0)$arr['mobile'] = $rs['mobile']; $barr['errcode']=-1; $msg = ''; if(isempt($rs['mobile']) && isempt($rs['email'])){ $msg = '手机号,邮箱不能同时为空'; } if($msg=='' && !$this->isempt($rs['mobile']))if(!is_numeric($rs['mobile']) || strlen($rs['mobile'])!=11){ $msg ='手机号码格式不对'; } if($msg=='' && !$this->isempt($rs['email']))if(!$this->checkEmail($rs['email'])){ $msg ='邮箱格式不对'; } if($msg==''){ if(!$rs1){ $barr = $this->createuser($userid, $arr); }else{ $barr = $this->updateuser($rs1['userid'], $arr); } }else{ $barr['errcode']=-1; $barr['msg']=$msg; } return $barr; } public function isgeng($urs, $rs) { if(!$urs || !$rs)return 1; $gender = ($rs['sex']=='男') ? '1' : '2'; $isgc = 0; if($urs['position']!=$rs['ranking'] || $urs['name']!=$rs['name'] || $urs['tel']!=$rs['tel'] || $urs['email']!=$rs['email']){ $isgc = 1; } return $isgc; } public function getuserjssdk($code) { $token = $this->gettoken(); $url = ''.$this->gettourl('URL_getuserinfo').'?access_token='.$token.'&code='.$code.''; $barr = $this->backarr; $result = c('curl')->getcurl($url); if(!$this->isempt($result)){ $arr = json_decode($result); $barr['errcode'] = $arr->errcode; $barr['msg'] = $arr->errmsg; if($arr->errcode==0){ $userid = $arr->userid; $onrs = $this->getone("`userid`='$userid'"); if(!$onrs)return $this->setbackarr(-1,'找不到钉钉用户'); $mobile = $onrs['mobile']; $name = $onrs['name']; $email = $onrs['email']; $where = "`user`='$userid'"; if(!isempt($mobile))$where.=" or `mobile`='$mobile'"; if(!isempt($email))$where.=" or `email`='$email'"; $urows = m('admin')->getrows("`status`=1 and ($where)",'`user`,`pass`,`name`'); if(!$urows)return $this->setbackarr(-1,'系统用户不存在'); if(count($urows)!=1)return $this->setbackarr(-1,'存在重复用户，请联系管理员设置'); $urs = $urows[0]; $barr['ptoken'] = md5($urs['pass']); $barr['user'] = $urs['user']; } } return $barr; } }