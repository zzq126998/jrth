<?php
/**
*	来自：信呼开发团队
*	作者：磐石(rainrock)
*	网址：http://www.rockoa.com/
*	系统文件
*/
class weixinqy_deptClassModel extends weixinqyModel { public function initWeixin() { $this->settable('wxqy_dept'); } public function getdeptlist() { $token = $this->gettoken(); if(isempt($token))return $this->tokenerr(); $url = ''.$this->gettourl('URL_deptlist').'?access_token='.$token.''; $barr = $this->backarr; $result = c('curl')->getcurl($url); if(!$this->isempt($result)){ $arr = json_decode($result); $barr = $this->setbackarr($arr->errcode, $arr->errmsg); if($arr->errmsg=='ok'){ $list = $arr->department; $idss = '0'; foreach($list as $k=>$rs){ $name = $rs->name; $id = $rs->id; $parentid = $rs->parentid; $order = $rs->order; $idss .= ','.$id.''; $ids = (int)$this->getmou('id', "`id`='$id'"); $where = ''; if($ids>0)$where="`id`=$ids"; $this->record(array( 'id' => $id, 'name' => $name, 'parentid' => $parentid, 'order' => $order ), $where); } $this->delete("id not in($idss)"); } } return $barr; } public function anaytosys() { $barr = $this->backarr; $rows = $this->getall('id>0'); if(!$rows){ $barr['msg']='请先获取列表在同步'; return $barr; } $idss = '0'; $db = m('dept'); foreach($rows as $k=>$rs){ $name = $rs['name']; $id = $rs['id']; $pid = $rs['parentid']; $sort = $rs['order']; $idss .= ','.$id.''; $ids = (int)$db->getmou('id', "`id`='$id'"); $where = ''; if($ids>0)$where="`id`=$ids"; $db->record(array( 'id' => $id, 'name' => $name, 'pid' => $pid ), $where); } $db->delete("id not in($idss)"); $barr['errcode'] = 0; $barr['msg'] = '同步成功'; return $barr; } public function createdept($id, $name, $parentid, $order) { if($parentid==1)$parentid = $this->deptrootid; $body = '{"name": "'.$name.'","parentid": '.$parentid.',"order": '.$order.',"id": '.$id.'}'; $token = $this->gettoken(); $url = ''.$this->gettourl('URL_deptcreate').'?access_token='.$token.''; $barr = $this->backarr; $result = c('curl')->postcurl($url, $body); if($result!=''){ $arr = json_decode($result); $barr = $this->setbackarr($arr->errcode, $arr->errmsg); if($arr->errcode==0){ $this->record(array( 'id' => $id, 'name' => $name, 'parentid' => $parentid, 'order' => $order )); } } return $barr; } public function updatedept($id, $name, $parentid, $order) { $body = '{"name": "'.$name.'","order": '.$order.''; if($parentid>0){ if($parentid==1)$parentid = $this->deptrootid; $body.= ',"parentid": '.$parentid.''; } $body .= ',"id": '.$id.'}'; $token = $this->gettoken(); $url = ''.$this->gettourl('URL_deptupdate').'?access_token='.$token.''; $barr = $this->backarr; $result = c('curl')->postcurl($url, $body); if($result!=''){ $arr = json_decode($result); $barr = $this->setbackarr($arr->errcode, $arr->errmsg); if($arr->errcode==0){ $this->record(array( 'id' => $id, 'name' => $name, 'parentid' => $parentid, 'order' => $order ),"`id`='$id'"); } } return $barr; } public function deletedept($id) { $token = $this->gettoken(); $url = ''.$this->gettourl('URL_deptdelete').'?access_token='.$token.'&id='.$id.''; $barr = $this->backarr; $result = c('curl')->getcurl($url); if(!$this->isempt($result)){ $arr = json_decode($result); $barr = $this->setbackarr($arr->errcode, $arr->errmsg); if($arr->errcode==0){ $this->delete($id); } } return $barr; } }