<?php
/**
*	来自：信呼开发团队
*	作者：磐石(rainrock)
*	网址：http://www.rockoa.com/
*	系统文件
*/
class weixinqy_indexClassModel extends weixinqyModel { public function getagentid($names) { $agesta = explode(',', $names); $name = $agesta[0]; $sid = -1; $where = "`name`='$name'"; if(is_numeric($name))$where='`agentid`='.$name.''; $nsrs = $this->db->getone('[Q]wxqy_agent', $where, 'agentid'); if($nsrs){ $sid = (int)$nsrs['agentid']; } if($sid==-1 && count($agesta)>1){ $sid = $this->getagentid(substr($names, strpos($names, ',')+1)); } return $sid; } private function sendmsg($touid, $agentname, $body) { $agentid= $this->getagentid($agentname); $msg = ''; $barr = array('errcode' => -1,'msg' => 'sorry!error'); if($agentid==-1){ $msg= '应用['.$agentname.']不存在'; $barr['msg'] = $msg; return $barr; } $touser = ''; $maxu = 980; $toarr = array(); $names = ''; if($touid=='all'){ $touser = '@all'; $toarr[]= $touser; }else{ $uarrs = $this->db->getall("select a.`user`,a.`name` from `[Q]admin` a left join `[Q]wxqy_user` b on a.`user`=b.`userid` where a.`status`=1 and b.id is not null and b.`status`=1 and a.`id` in($touid)"); $xushu = 0; foreach($uarrs as $k=>$rs){ $xushu++; $touser.='|'.$rs['user'].''; if($xushu % $maxu==0){ $touser = substr($touser, 1); $toarr[]= $touser; $touser = ''; } } if($touser!=''){ $touser = substr($touser, 1); $toarr[]= $touser; } } if(!$toarr){ $uarrs = $this->db->getall("select `name` from `[Q]admin` where `id` in($touid)"); foreach($uarrs as $k=>$rs)$names.=','.$rs['name'].''; $msg= '用户['.$touid.''.$names.']未激活企业微信，请到[系统→企业微信→企业微信用户]下查看激活状态，应用['.$agentname.']'; $barr['msg'] = $msg; return $barr; } foreach($toarr as $touser1){ $bodystr = str_replace(array('{touser}', '{agentid}', "\n", URL), array($touser1, $agentid, '<br>', $this->rock->getouturl()), $body); $ybbo = false; if(getconfig('asynsend')){ $ybbo = m('reim')->asynurl('asynrun','wxqysendmsg', array( 'body' => $this->rock->jm->base64encode($bodystr), 'agentid' => $agentid )); $barr['errcode'] = 0; $barr['msg'] = '异步发送'; } if(!$ybbo)$barr = $this->sendbody($bodystr, $agentid); } return $barr; } public function sendbody($body, $agentid) { $barr = array('errcode' => -1,'msg' => 'sorry!error'); $token = $this->gettoken($agentid, true); $url = ''.$this->gettourl('URL_messagesend').'?access_token='.$token.''; $result = c('curl')->postcurl($url, $body); if($result!=''){ $arr = json_decode($result); $barr['errcode'] = $arr->errcode; $barr['msg'] = $this->geterrstr($arr->errcode, $arr->errmsg); } return $barr; } public function sendtext($touid, $agentname, $cont) { $body = '{"touser": "{touser}","msgtype": "text","agentid":{agentid},"text": {"content": "'.$cont.'"}}'; return $this->sendmsg($touid, $agentname, $body); } public function sendnews($touid, $agentname, $cont0=array(), $cont1=false, $cont2=false) { $s1 = ''; foreach($cont0 as $k=>$v){ if($k=='url')$v.= (contain($v,'?') ? '&' : '?').'agentid={agentid}'; $s1.=',"'.$k.'":"'.$v.'"'; } if($s1!='')$s1 = substr($s1,1); $articles = '[{'.$s1.'}]'; $body = '{"touser": "{touser}","msgtype": "news","agentid":{agentid},"news":{"articles": '.$articles.'}}'; $barr = $this->sendmsg($touid, $agentname, $body); return $barr; } public function sendtextcard($touid, $agentname, $cont0=array()) { $s1 = ''; foreach($cont0 as $k=>$v){ if($k=='url')$v.= (contain($v,'?') ? '&' : '?').'agentid={agentid}'; $s1.=',"'.$k.'":"'.$v.'"'; } if($s1!='')$s1 = substr($s1,1); $articles = '{'.$s1.'}'; $body = '{"touser": "{touser}","msgtype": "textcard","agentid":{agentid},"textcard":'.$articles.'}'; $barr = $this->sendmsg($touid, $agentname, $body); return $barr; } public function sendtaskcard($touid, $agentname, $sarr=array()) { $url = arrvalue($sarr,'url'); if(!isempt($url)){ $url.= (contain($url,'?') ? '&' : '?').'agentid={agentid}'; $sarr['url'] = $url; } $taskcard = json_encode($sarr, JSON_UNESCAPED_UNICODE); $body = '{"touser": "{touser}","msgtype": "taskcard","agentid":{agentid},"taskcard":'.$taskcard.'}'; $barr = $this->sendmsg($touid, $agentname, $body); return $barr; } public function sendxiao($touid, $agentname, $wxarr=array()) { $barr = $this->backarr; if(isset($wxarr['picurl'])){ $barr = $this->sendnews($touid, $agentname, $wxarr); }elseif(isset($wxarr['task_id']) && isset($wxarr['btn'])){ $barr = $this->sendtaskcard($touid, $agentname, $wxarr); }elseif($wxarr['url'] != ''){ $barr = $this->sendtextcard($touid, $agentname, $wxarr); }else{ $cont = $wxarr['title'].'<br>'.$wxarr['description']; $barr = $this->sendtext($touid, $agentname, $cont); } return $barr; } }