<?php
/**
*	来自：信呼开发团队
*	作者：磐石(rainrock)
*	网址：http://www.rockoa.com/
*	系统文件
*/
class weixinqy_mediaClassModel extends weixinqyModel { public function upload($file, $type='') { $token = $this->gettoken(); if($type=='')$type = 'image'; $url = ''.$this->gettourl('URL_mediaupload').'?access_token='.$token.'&type='.$type.''; $data = array('media'=>'@'.ROOT_PATH.'/'.$file); $result = c('curl')->postcurl($url, $data, 1); $barr = $this->backarr; $barr['msg']= '上传出错'; if($result != ''){ $barr = json_decode($result, true); $barr['msg'] = $barr['errmsg']; } return $barr; } public function downmedia($mediaid, $type='amr',$msgid='') { $agentid = $this->rock->session('wxqyagentid'); if(!isempt($agentid)){ $token = $this->gettoken(); }else{ $token = $this->gettoken(); } $url = ''.$this->gettourl('URL_mediaget').'?access_token='.$token.'&media_id='.$mediaid.''; $curl = c('curl'); $result = $curl->getcurl($url); $barr = $this->backarr; $bo = false; $filenas= substr(md5($mediaid),0,20); $filena = ''.UPDIR.'/'.date('Y-m').'/'.$filenas.''; if(!isempt($result) && !contain($result, 'errcode')){ $sfile = ''.$filena.'.'.$type.''; $bo = $this->rock->createtxt($sfile , $result); } if(!$bo){ $this->rock->debugs($result.'|'.$agentid,'wxqy_downmedia'); $carr = json_decode($result, true); $barr['msg']= '下载出错:'.arrvalue($carr, 'errmsg').''; }else{ $upobj = c('upfile'); $fileext = c('file')->getfiletoExt($sfile, $type); if($fileext != $type){ copy($sfile, $filena.'.'.$fileext); unlink($sfile); $sfile = $filena.'.'.$fileext; } $sfile = $upobj->filesave($sfile, $filenas, ''.UPDIR.'/'.date('Y-m').'', $fileext); $barr['errcode'] = 0; $barr['msg'] = 'ok'; $barr['filepath'] = $sfile; $uarr['filepath'] = $sfile; $uarr['filename'] = ''.$filenas.'.'.$fileext.''; $uarr['fileext'] = $fileext; $uarr['filesize'] = filesize($sfile); $uarr['filesizecn'] = $upobj->formatsize($uarr['filesize']); $uarr['optid'] = $this->adminid; $uarr['optname'] = $this->adminname; $uarr['adddt'] = $this->rock->now; $uarr['ip'] = $this->rock->ip; $uarr['web'] = '企业微信素材'; $fobj = m('file'); $fileid = (int)$fobj->getmou('id',"`filename`='".$uarr['filename']."'"); if($fileid==0)$fileid = $fobj->insert($uarr); $barr['id'] = $fileid; $barr['filesize'] = $uarr['filesize']; $barr['filesizecn'] = $uarr['filesizecn']; $barr['fileext'] = $uarr['fileext']; $barr['filename'] = $uarr['filename']; if(!isempt($msgid)){ $dbss = m('im_mess'); $mors = $dbss->getone("`msgid`='$msgid'",'id'); if($mors){ $id = $mors['id']; $dbss->update(array('fileid' => $fileid), $id); $fobj->addfile($fileid, 'im_mess', $id); } } } return $barr; } }