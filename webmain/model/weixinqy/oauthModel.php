<?php
/**
*	来自：信呼开发团队
*	作者：磐石(rainrock)
*	网址：http://www.rockoa.com/
*	系统文件
*/
class weixinqy_oauthClassModel extends weixinqyModel { public function login($lx='') { $this->readwxset(); if($this->corpid==''){ $url = '?m=login&d=we#notuserid'; $this->rock->location($url); return false; } $burl = $this->rock->get('backurl'); $redurl = ''.$this->rock->getouturl().'?m=login&d=we&a='.$lx.'wxlogincode'; if($burl!='')$redurl.='&backurl='.$burl.''; $redirect_uri = urlencode($redurl); $url = 'https://open.weixin.qq.com/connect/oauth2/authorize?appid='.$this->corpid.'&redirect_uri='.$redirect_uri.'&response_type=code&scope=snsapi_base&state=login#wechat_redirect'; $this->rock->location($url); return true; } public function logincode($blx='') { $code = $this->rock->get('code'); $state = $this->rock->get('state'); if($code=='')return; $agentid= $this->rock->session('wxqyagentid'); if(isempt($agentid)){ $devagent = m('option')->getval('weixinqy_devagent'); if(isempt($devagent))$devagent = '办公助手'; $agentid = m('weixinqy:index')->getagentid($devagent); } $UserId = $DeviceId = ''; $burl = $this->rock->get('backurl'); if(!isempt($agentid)){ $token = $this->gettoken($agentid); $url = ''.$this->gettourl('URL_getuserinfo').'?access_token='.$token.'&code='.$code.''; $result = c('curl')->getcurl($url); if($result != ''){ $arr = json_decode($result); if(isset($arr->UserId))$UserId = $arr->UserId ; if(isset($arr->DeviceId))$DeviceId = $arr->DeviceId; } } $userid = $UserId; if(!isempt($userid)){ $usr = m('admin')->getone("`user`='$userid' and `status`=1",'`id`,`pass`,`user`,`name`'); if(!$usr)$userid=''; $ptoken = md5($usr['pass']); $url = '?m=login&d=we&user='.$this->rock->jm->base64encode($userid).'&ptoken='.$ptoken.''; if($burl!='')$url.='&backurl='.$burl.''; if($DeviceId!=''){ $DeviceId = md5($DeviceId); m('weixinqy:user')->update("`weixinid`='$DeviceId'", "`userid`='$userid'"); } if($blx=='qy' && !isempt($userid)){ } } if(isempt($userid)){ $url = '?m=login&d=we'; if($burl!='')$url.='&backurl='.$burl.''; $url.= '#notuserid'; } $this->rock->location($url); } }