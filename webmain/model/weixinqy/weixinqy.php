<?php
/**
*	来自：信呼开发团队
*	作者：磐石(rainrock)
*	网址：http://www.rockoa.com/
*	系统文件
*/
class weixinqyModel extends Model { protected $URL_public = 'de0eo0mo0rm0dd0eo0ee0br0er0pcb0ee0rm0em0poo0ppb0pcd0ez0poo0mp0bp0ed0bp0ec0bz0md0mm0aa0ppo0ea0ppc0pcc0pcm0de0mm0pcr0ppo0dm0pcb0bz0poc0dd0mz0bz0pca0dm0bc0rm0ppm0md0bc0pcc0ppo0ea0me0er0ppo0dm0pcb0ba0bm06'; protected $URL_gettoken = 'bk0pk0ro0cr0lkk0zl0pz0llc0bk0rz0pg0pr02'; protected $URL_jsapiticket = 'dc0bc0ma0rm0mm0bc0ppo0poo0md0mm0aa0ppo0mm0bp0mo0ppo0md0bc0ppa0pcm0pcc0ab0bm0bm06'; protected $URL_messagesend = 'qd0dm0de0ozz0qq0ap0mp0oop0qp0dr0am0ozz0qp0dm0ar0opm07'; protected $URL_mediaupload = 'fq0qd0qm0zod0fd0qd0mf0zzq0zoo0qq0mm0zze0fq0eo0do0zod08'; protected $URL_mediaget = 'ab0br0bz0glr0ar0br0za0ggb0al0ol0bz0pb03'; protected $URL_getuserinfo = 'eaa0yy0iy0eay0vv0eaf0fi0eea0va0yy0ym0qv0vv0fa0yt0eme0vi0yi0fd0eav0vy0eev0fy0fy012'; protected $URL_userlist = 'opp0dd0md0opd0qq0opa0am0ooa0qm0dd0md0bd07'; protected $URL_userget = 'gll0bb0rb0glb0aa0glo0or0ggl0al0bb0bg0ob03'; protected $URL_usercreate = 'gll0bb0rb0glb0aa0glo0or0glz0aa0gla0bz0glp0gll0rg0bo0ob03'; protected $URL_userupdate = 'zoo0qq0dq0zoq0ff0zoe0ed0af0ff0dz0qr0zoa0zoo0dz0qe0eq08'; protected $URL_userdelete = 'mee0vv0yv0mev0hh0met0ty0mey0he0vy0mde0mev0mee0ym0vt0tv013'; protected $URL_batchdelete = 'zoo0qq0dq0zoq0ff0zoe0ed0zoe0qf0qq0qr0zom0fd0dz0qr0zoq0fq0dz0qm0aq0fo0qz0eq0eq08'; protected $URL_deptlist = 'fo0dz0qm0zzf0qf0qq0da0aq0fq0qd0qm0zzd0zoo0md0ed0zze0fd0qq0dq0aq08'; protected $URL_deptcreate = 'tz0qr0fd0rrt0ft0ff0qe0ef0tf0fq0fd0rrq0rzz0dq0mq0rzd0tt0rzt0fd0rze0rzz0qr0fm0mf09'; protected $URL_deptupdate = 'he0ym0vi0mmh0vh0vv0yf0fv0hv0vy0vi0mmy0mee0iy0ty0fh0hh0ym0vd0mef0mee0ym0vt0tv013'; protected $URL_deptdelete = 'fo0dz0qm0zzf0qf0qq0da0aq0fq0qd0qm0zzd0zoo0md0ed0zod0fo0qd0zro0zoq0zoo0dz0qe0eq08'; protected $URL_agentget = 'ae0ab0xgg0xga0ea0xxg0ax0xxa0eg0zg0ar0oa04'; protected $URL_agentset = 'ae0ab0xgg0xga0ea0xxg0ax0xxa0ee0zg0ar0oa04'; protected $URL_chatcreate = 'appchat/create'; protected $URL_chatsend = 'appchat/send'; protected $URL_checkindata = 'md0bc0pcr0pcm0md0bc0ppa0ppo0dm0pcb0be0ppc0dc0mm0mo0pca0de0ep0ma0pca0de0bc0pcm0ppe0dc0ep0ec0rm0md0mp0bm0bm06'; protected $URL_checkinoption= 'ae0zg0xgo0xga0ae0zg0xxr0xxc0ea0xgz0zb0xxg0eg0aa0ac0xgr0eb0bx0ar0xgr0eb0zg0xga0xxb0ea0zx0rr0oa0eb0ab0zb0xxb04'; protected $URL_menuget = 'ab0br0bz0ggr0gll0bc0or0ggl0al0bb0bg0ob03'; protected $URL_menudelete = 'me0ea0eb0cca0cxx0eo0ra0cxa0mx0ea0cpx0cxe0cxx0ac0er0re05'; protected $URL_menucreate = 'rz0zo0zp0kko0kss0zg0co0ksp0rr0ksr0zp0ksx0kss0ok0zc0cz01'; public $corpid = ''; public $secret = ''; public $backarr = array(); public $deptrootid = 1; public function initWeixin(){} public function initModel() { $this->backarr = array('errcode'=>-1, 'msg'=>'sorry,error'); $this->option = m('option'); $djid = (int)$this->option->getval('weixinqy_deptid','0'); if($djid>0)$this->deptrootid = $djid; $this->initWeixin(); } public function gettourl($can) { $url = $this->URL_public; if(substr($url,0,4)!='http'){ $url=$this->rock->jm->uncrypt($url); $url.=$this->rock->jm->uncrypt($this->$can); }else{ $url.=$this->$can; } if(substr($url,0,4)!='http'){ echo json_encode($this->backerror('访问有误，请重新安装模块')); exit; } return $url; } public function readwxset() { if($this->corpid!='')return; $this->corpid = $this->option->getval('weixinqy_corpid'); $this->secret = $this->option->getval('weixinqy_secret'); if($this->corpid=='')showreturn('','没有设置企业微信',201); return $this->corpid; } public function gethuidiao() { $huitoken = $this->option->getval('weixinqy_huitoken'); $aeskey = $this->option->getval('weixinqy_aeskey'); $corpid = $this->corpid; if($corpid=='')$corpid = $this->option->getval('weixinqy_corpid'); return array( 'huitoken' => $huitoken, 'aeskey' => $aeskey, 'corpid' => $corpid, ); } public function gettoken($lx=0, $isyy=false) { $time = date('Y-m-d H:i:s', time()-2*3600); $num = 'weixinqy_token'.$lx.''; if($isyy)$num.='_agent'; $rs = $this->option->getone("`num`='$num' and `optdt`>'$time'"); $val = ''; if($rs)$val = $rs['value']; if(isempt($val)){ $this->readwxset(); $secret = $this->secret; if($lx>0 || $isyy){ $secret = m('wxqy_agent')->getmou('secret', "`agentid`='$lx'"); } if($isyy && isempt($secret))showreturn('','请先设置应用的secret', 201); if(isempt($secret))return ''; $url = ''.$this->gettourl('URL_gettoken').'?corpid='.$this->corpid.'&corpsecret='.$secret.''; $result = c('curl')->getcurl($url); if($result != ''){ $arr = json_decode($result); if(!isset($arr->access_token)){ showreturn('',$result,201); }else{ $val = $arr->access_token; $this->option->setval($num, $val); } } } return $val; } public function getticket($lx) { $time = date('Y-m-d H:i:s', time()-2*3600); $num = 'weixinqy_jssdk_token'.$lx.''; $rs = $this->option->getone("`num`='$num' and `optdt`>'$time'"); $val = ''; if($rs)$val = $rs['value']; if(isempt($val)){ $token = $this->gettoken($lx); $url = ''.$this->gettourl('URL_jsapiticket').'?access_token='.$token.''; $result = c('curl')->getcurl($url); if($result != ''){ $arr = json_decode($result); if(!isset($arr->ticket)){ showreturn('', $result, 201); }else{ $val = $arr->ticket; $this->option->setval($num, $val); } } } return $val; } public function setbackarr($code, $msg) { $msg = $this->geterrstr($code, $msg); $this->backarr = array('errcode'=>$code, 'msg'=>$msg); return $this->backarr; } public function backerror($msg, $code=-1) { return $this->setbackarr($code, $msg); } public function clearalltoken() { $this->option->update("value=null", "`num` like 'weixinqy\_%'"); } public function tokenerr() { $this->backarr['msg'] = '无法获取token'; return $this->backarr; } private $errorarray = false; public function geterrstr($code, $str1='') { $str = '{"40001":"不合法的secret参数","40003":"无效的UserID","40004":"不合法的媒体文件类型","40005":"不合法的type参数","40006":"不合法的文件大小","40007":"不合法的media_id参数","40008":"不合法的msgtype参数","40013":"不合法的CorpID","40014":"不合法的access_token","40016":"不合法的按钮个数","40017":"不合法的按钮类型","40018":"不合法的按钮名字长度","40019":"不合法的按钮KEY长度","40020":"不合法的按钮URL长度","40022":"不合法的子菜单级数","40023":"不合法的子菜单按钮个数","40024":"不合法的子菜单按钮类型","40025":"不合法的子菜单按钮名字长度","40026":"不合法的子菜单按钮KEY长度","40027":"不合法的子菜单按钮URL长度","40029":"不合法的oauth_code","40031":"不合法的UserID列表","40032":"不合法的UserID列表长度","40033":"不合法的请求字符","40054":"不合法的子菜单url域名","40055":"不合法的菜单url域名","40056":"不合法的agentid","40057":"不合法的callbackurl或者callbackurl验证失败","40058":"不合法的参数","40059":"不合法的上报地理位置标志位","40063":"参数为空","40066":"不合法的部门列表","40068":"不合法的标签ID","40071":"不合法的标签名字","40072":"不合法的标签名字长度","40073":"不合法的openid","40074":"news消息不支持保密消息类型","40077":"不合法的pre_auth_code参数","40078":"不合法的auth_code参数","40080":"不合法的suite_secret","40082":"不合法的suite_token","40083":"不合法的suite_id","40084":"不合法的permanent_code参数","40085":"不合法的的suite_ticket参数","40086":"不合法的第三方应用appid","40092":"导入文件存在不合法的内容","40093":"不合法的jsapi_ticket参数","40094":"不合法的URL","41001":"缺少access_token参数","41002":"缺少corpid参数","41004":"缺少secret参数","41008":"缺少auth code参数","41009":"缺少userid参数","41010":"缺少url参数","41011":"缺少agentid参数","41016":"缺少title参数","41017":"缺少tagid参数","41021":"缺少suite_id参数","41025":"缺少permanent_code参数","42001":"access_token已过期","42007":"pre_auth_code已过期","42009":"suite_access_token已过期","43004":"指定的userid未绑定微信或未关注微信插件","44004":"文本消息content参数为空","45001":"多媒体文件大小超过限制","45002":"消息内容大小超过限制","45004":"应用description参数长度不符合系统限制","45007":"语音播放时间超过限制","45008":"图文消息的文章数量不符合系统限制","45009":"接口调用超过限制","45022":"应用name参数长度不符合系统限制","45024":"帐号数量超过上限","45026":"触发删除用户数的保护","45032":"图文消息author参数长度超过限制","46003":"菜单未设置","48002":"API接口无权限调用","48003":"不合法的suite_id","48004":"授权关系无效","48005":"API接口已废弃","50001":"redirect_url未登记可信域名","50002":"成员不在权限范围","50003":"应用已禁用","60001":"部门长度不符合限制","60003":"部门ID不存在","60004":"父部门不存在","60005":"部门下存在成员","60006":"部门下存在子部门","60007":"不允许删除根部门","60008":"部门已存在","60009":"部门名称含有非法字符","60010":"部门存在循环关系","60011":"指定的成员\/部门\/标签参数无权限","60012":"不允许删除默认应用","60020":"访问ip不在白名单之中","60102":"UserID已存在","60103":"手机号码不合法","60104":"手机号码已存在","60105":"邮箱不合法","60106":"邮箱已存在","60110":"用户所属部门数量超过限制","60111":"UserID不存在","60112":"成员name参数不合法","60123":"无效的部门id","60124":"无效的父部门id","60125":"非法部门名字","60127":"缺少department参数","60129":"成员手机和邮箱都为空","72023":"发票已被其他公众号锁定","72024":"发票状态错误","72037":"存在发票不属于该用户","80001":"可信域名不正确，或者无ICP备案","81001":"部门下的结点数超过限制（3W）","81002":"部门最多15层","81011":"无权限操作标签","82002":"不合法的PartyID列表长度","82003":"不合法的TagID列表长度","84019":"缺少templateid参数","84020":"templateid不存在","84021":"缺少register_code参数","84022":"无效的register_code参数","84023":"不允许调用设置通讯录同步完成接口","84024":"无注册信息","85002":"包含不合法的词语","85004":"每企业每个月设置的可信域名不可超过20个","85005":"可信域名未通过所有权校验","301024":"获取打卡数据时间间隔不能大于93天"}'; if(!$this->errorarray)$this->errorarray = json_decode($str, true); $bstr = arrvalue($this->errorarray, $code); if(!isempt($bstr)){ $str1 = '('.$bstr.')'.$str1.','.c('xinhu')->helpstr('wxqymsg').''; } return $str1; } }