<?php
/**
*	来自：信呼开发团队
*	作者：磐石(rainrock)
*	网址：http://www.rockoa.com/
*	系统文件
*/
class weixinqyClassAction extends Action { public function setsaveAjax() { m('weixinqy:index')->clearalltoken(); $devagent = $this->post('devagent'); $this->option->setval('weixinqy_corpid@-3', $this->post('corpid')); $this->option->setval('weixinqy_deptid@-3', $this->post('deptid')); $this->option->setval('weixinqy_secret@-3', $this->post('secret')); $this->option->setval('weixinqy_huitoken@-3', $this->post('huitoken')); $this->option->setval('weixinqy_aeskey@-3', $this->post('aeskey')); $this->option->setval('weixinqy_devagent@-3', $devagent); if(!isempt($devagent)){ $to = m('wxqy_agent')->rows("`name`='$devagent' and ifnull(`secret`,'')<>''"); if($to==0)return '默认推送应用['.$devagent.']不存在，请先到[系统→企业微信→企业微信应用]下配置'; } return 'ok'; } public function getsetAjax() { $arr= array(); $arr['corpid'] = $this->option->getval('weixinqy_corpid'); $arr['deptid'] = $this->option->getval('weixinqy_deptid'); $arr['secret'] = $this->option->getval('weixinqy_secret'); $arr['huitoken'] = $this->option->getval('weixinqy_huitoken'); $arr['aeskey'] = $this->option->getval('weixinqy_aeskey'); $arr['devagent'] = $this->option->getval('weixinqy_devagent'); $arr['huiurl'] = ''.URL.'api.php?m=wxqy'; echo json_encode($arr); } public function testsendAjax() { $lx = (int)$this->get('lx'); if($lx==0){ $val = m('weixin:weixin')->getticket(); }else{ $val = 'ok'; $barr = m('weixin:chat')->send(8, 'user', $this->adminid,"这是一个发送测试，不要紧张\n".$this->now.""); if($barr['errcode']!=0){ showreturn('', $barr['msg']); } } if($val==''){ showreturn('','测试失败'); }else{ showreturn('','测试成功'); } } public function clearwxqihAjax() { $this->option->update("value=null", "`num` like 'weixin\_%'"); } public function updatedeptAjax() { $arr = m('weixinqy:dept')->getdeptlist(); $this->returnjson($arr); } public function optdeptAjax() { $ids = $this->get('ids'); $db = m('weixinqy:dept'); $oi = $db->rows($ids); $rs = $this->db->getone('[Q]dept','id='.$ids.''); $maxxu = (int)$this->db->getmou('[Q]dept','max(sort)','pid='.$rs['pid'].''); $sort = $maxxu - (int)$rs['sort']; if($oi==0){ $barr = $db->createdept($rs['id'], $rs['name'], $rs['pid'], $sort); }else{ $barr = $db->updatedept($rs['id'], $rs['name'], $rs['pid'], $sort); } $this->returnjson($barr); } public function deletedeptAjax() { $ids = $this->get('ids'); $arr = m('weixinqy:dept')->deletedept($ids); $this->returnjson($arr); } public function deptwxdataAjax() { $this->rows = array(); $this->getdeptwx(0, 1); $this->returnjson(array( 'totalCount'=> 0, 'rows' => $this->rows )); } private function getdeptwx($pid, $oi) { $db = m('weixinqy:dept'); $menu = $db->getall("`parentid`='$pid' order by `order` desc",'*'); foreach($menu as $k=>$rs){ $sid = $rs['id']; if($sid==$db->deptrootid)$sid = '1'; $rs['level'] = $oi; $rs['stotal'] = $db->rows("`parentid`='$sid'"); $zt = $this->db->rows('[Q]dept', $sid); $rs['zt'] = $zt; $this->rows[] = $rs; $this->getdeptwx($rs['id'], $oi+1); } } public function deptdataAjax() { $this->rows = array(); $this->getdept(0, 1); $this->returnjson(array( 'totalCount'=> 0, 'rows' => $this->rows )); } private function getdept($pid, $oi) { $db = m('dept'); $dbwx = m('weixinqy:dept'); $menu = $db->getall("`pid`='$pid' order by `sort`",'*'); foreach($menu as $k=>$rs){ $sid = $rs['id']; $rs['level'] = $oi; $rs['stotal'] = $db->rows("`pid`='$sid'"); if($sid == 1)$sid = $dbwx->deptrootid; $where = "`name`='".$rs['name']."' and `id`='$sid'"; $zt = $dbwx->rows($where); $rs['zt'] = $zt; $this->rows[] = $rs; $this->getdept($rs['id'], $oi+1); } } public function anaytodeptAjax() { $arr = m('weixinqy:dept')->anaytosys(); $this->returnjson($arr); } public function beforeusershow($table) { $fields = 'id,name,`user`,deptname,status,tel,ranking,superman,loginci,deptid,sex,mobile,email,weixinid,sort,face'; if(VERSION>='1.5.8')$fields.=',deptids,deptnames'; $s = ''; $key = $this->post('key'); $zt = $this->post('zt'); if($key!=''){ $s = " and (`name` like '%$key%' or `user` like '%$key%' or `ranking` like '%$key%' or `deptname` like '%$key%' "; if(VERSION>='1.5.8')$s.=" or `deptnames` like '%$key%'"; $s.= ')'; } if($zt=='0')$s.=" and `status`=0"; if($zt=='1')$s.=" and `status`=1"; if($zt=='2'){ $s.=" and `user` in(select `userid` from `[Q]wxqy_user` where `status`=1)"; } if($zt=='3'){ $s.=" and `user` in(select `userid` from `[Q]wxqy_user` where `status`=4)"; } if($zt=='4'){ $s.=" and `user` not in(select `userid` from `[Q]wxqy_user`)"; } return array( 'fields'=> $fields, 'where' => $s ); } public function afterusershow($table, $rows) { $db = m('weixinqy:user'); foreach($rows as $k=>$rs){ $iscj = 0; $isgz = 0; $urs = $db->getone("`userid`='".$rs['user']."'"); if($urs){ $iscj = 1; $isgz = (int)arrvalue($urs,'status',0); } $rows[$k]['iscj'] = $iscj; $rows[$k]['isgz'] = $isgz; $gxarr = $db->isgeng($urs, $rs); $rows[$k]['isgc'] = $gxarr[0]; $rows[$k]['isgcstr'] = $gxarr[1]; $rows[$k]['mobile'] = substr($rs['mobile'],0,3).'****'.substr($rs['mobile'],-4); } $noarr = $db->notinadmin(); return array('rows'=>$rows,'notstr'=>join(',', $noarr)); } public function reloaduserAjax() { $arr = m('weixinqy:user')->getuserlist(); $this->returnjson($arr); } public function optuserAjax() { $id = (int)$this->post('id'); $barr = m('weixinqy:user')->optuserwx($id); $this->returnjson($barr); } public function delalluserAjax() { $ids = $this->get('ids'); $arr = m('weixinqy:user')->delusernoinstr($ids); $this->returnjson($arr); } public function anaytouserAjax() { $arr = m('weixinqy:user')->anaytosys(); $this->returnjson($arr); } public function sendanayfaceAjax() { $arr = m('weixinqy:user')->sendanayface(); $this->returnjson($arr); } public function sendanayfaceinitAjax() { $arr = m('weixinqy:user')->getnotface(); if(!$arr)return returnerror('激活的用户中都已经有头像了，不需要获取'); return returnsuccess($arr); } public function getfaceAjax() { $userid = $this->get('userid'); $barr = m('weixinqy:user')->anayface($userid); if($barr['errcode']!=0)return $barr['msg']; } public function getagentAjax() { $agentid = $this->request('agentid'); $barr = m('weixinqy:agent')->getagent($agentid); $this->returnjson($barr); } public function setagentAjax() { $agentid = $this->request('agentid'); $barr = m('weixinqy:agent')->setagent($agentid); $this->returnjson($barr); } public function sendagentAjax() { $name = $this->post('name'); $msg = $this->post('msg'); $barr = m('weixinqy:index')->sendtext($this->adminid, $name, $msg); $this->returnjson($barr); } public function senduserAjax() { $id = $this->post('id'); $msg = $this->post('msg'); $barr = m('weixinqy:index')->sendtext($id, '办公助手', $msg); $this->returnjson($barr); } public function delyingAjax() { $id = (int)$this->post('id'); m('wxqy_agent')->delete($id); $this->backmsg(); } public function daoruagentAjax() { $barr = m('weixinqy:agent')->daoruagent(); $this->returnjson($barr); } public function menugetAjax() { $agentid = $this->request('agentid'); $barr = m('weixinqy:agent')->getmenu($agentid); $this->returnjson($barr); } public function menuupdateAjax() { $agentid = $this->request('agentid'); $barr = m('weixinqy:agent')->menuupdate($agentid); $this->returnjson($barr); } public function savemenuAjax() { $id = (int)$this->post('id'); $menujson = $this->post('menujson'); m('weixinqy:agent')->update(array( 'menujson' => $menujson ), $id); echo 'ok'; } public function menudeleteAjax() { $agentid = $this->request('agentid'); $barr = m('weixinqy:agent')->menudelete($agentid); $this->returnjson($barr); } public function getchatlistAjax() { $barr = m('weixin:chat')->getchatlist(); $this->returnjson($barr); } public function getchatinfoAjax() { $barr = m('weixin:chat')->getchatinfo($this->get('chatid')); $this->returnjson($barr); } public function aftechatshow($table, $rows) { $db = m('weixin:chat'); foreach($rows as $k=>$rs){ $zt = $db->rows($rs['id']); $rows[$k]['zt'] = $zt; $rows[$k]['sontts'] = m('im_groupuser')->rows("gid='".$rs['id']."'"); } return array('rows'=>$rows); } public function createchatAjax() { $id = (int)$this->get('id'); $zt = m('wx_chat')->rows($id); if($zt==0){ $barr = m('weixin:chat')->chatcreate($id); }else{ $barr = m('weixin:chat')->chatupdate($id); } $this->returnjson($barr); } public function sendchatAjax() { $gid = (int)$this->post('gid'); $cont = $this->post('msg'); $barr = m('weixin:chat')->send($this->adminid, 'group', $gid, $cont); $this->returnjson($barr); } }